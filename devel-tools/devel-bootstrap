#!/usr/bin/env bash

# Bootstrap an environment for hacking on YABSM.

set -e

SCRIPT=${0##*/}

YABSM_ROOT=$(realpath "$(dirname "$(readlink -f "$0")")"/..)
cd "$YABSM_ROOT" || (echo "error: could not cd to dir '$YABSM_ROOT'" >&2 && exit 1)

USAGE=$(cat <<EOF
usage: $SCRIPT [OPTIONS]
Options are:
  -h            Show this help message.
  -d directory  Install Perl v5.16.3 to DIRECTORY. By default installs to 
                yabsm/perl-5.16.3.
  -s            Prevent passing --force flag to cpanm.
EOF
)

while [ -n "$1" ]; do
  opt="$1"
  shift
  case $opt in
    -h)
      echo "$USAGE"
      exit 0
      ;;
    -d)
      PERL_BUILD_DIR="$1"
      shift
      ;;
    -s)
      CPANM_FORCE_FLAG=no
      shift
      ;;
    *)
      echo "$USAGE"
      exit 1
      ;;
  esac  
done

PERL_BUILD_DIR=${PERL_BUILD_DIR:-"$YABSM_ROOT/perl-5.16.3"}
PERL_EXECUTABLE="$PERL_BUILD_DIR/bin/perl"

PERL_BUILD_COMMAND="curl -L https://raw.githubusercontent.com/tokuhirom/Perl-Build/master/perl-build | perl - 5.16.3 $PERL_BUILD_DIR"

PLX_EXECUTABLE="$YABSM_ROOT/plx"
PLX_INSTALL_COMMAND="wget https://raw.githubusercontent.com/shadowcat-mst/plx/master/bin/plx-packed -O $PLX_EXECUTABLE"

echo "$SCRIPT: Executing: $PERL_BUILD_COMMAND"
eval "$PERL_BUILD_COMMAND"

echo "$SCRIPT: Executing: $PLX_INSTALL_COMMAND"
eval "$PLX_INSTALL_COMMAND"

chmod 0774 "$PLX_EXECUTABLE"

$PLX_EXECUTABLE --init "$PERL_EXECUTABLE"
mv "$PLX_EXECUTABLE" "$YABSM_ROOT/.plx"
PLX_EXECUTABLE="$YABSM_ROOT/.plx/plx"

while read -r dep "$(sed -e 's/[\t ]//g;/^$/d' "$YABSM_ROOT/DEPENDENCIES")"; do
  YABSM_DEPENDENCIES="$YABSM_DEPENDENCIES $dep"
done

# use --force flag by default
if [ no == $CPANM_FORCE_FLAG ]; then
  CPANM_FORCE_FLAG=''
else
  CPANM_FORCE_FLAG='--force'
fi

INSTALL_DEPENDENCIES_COMMAND="$PLX_EXECUTABLE --cpanm -L local $CPANM_FORCE_FLAG -i $YABSM_DEPENDENCIES"

echo "$SCRIPT: Executing: $INSTALL_DEPENDENCIES_COMMAND"
eval "$INSTALL_DEPENDENCIES_COMMAND"
